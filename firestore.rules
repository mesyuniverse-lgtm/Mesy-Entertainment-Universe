/**
 * @fileOverview Firestore Security Rules for the Mesy Entertainment Universe platform.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for accounts and a global model for members.
 * - The `accounts` collection is private to each user.
 * - The `members` collection is global, but write access to a member document is restricted to the account owner.
 *
 * Data Structure:
 * - `accounts/{accountId}`: The root document for a user's account, only accessible by the owner.
 * - `members/{memberId}`: Globally unique member identities. Each contains an `accountId` linking to its owner.
 * - Public data (quests, rewards, stores) resides in top-level collections with appropriate rules.
 *
 * Key Security Decisions:
 * - A user can only access documents and subcollections under `/accounts/{request.auth.uid}`.
 * - A user can only write to a `members/{memberId}` document if the document's `accountId` matches their UID.
 * - Public read is allowed on `members` for profile pages.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper functions
     */
    function isSignedIn() {
      return request.auth != null;
    }

    function isAccountOwner(accountId) {
      return isSignedIn() && request.auth.uid == accountId;
    }

    /**
     * Rules for the /accounts/{accountId} collection. This is the root for all private user data.
     * Access is strictly limited to the owner of the account.
     */
    match /accounts/{accountId} {
      allow read, write: if isAccountOwner(accountId);

      match /profile/{profileId} {
        allow read, write: if isAccountOwner(accountId);
      }

      match /notifications/{notificationId} {
        allow read, write: if isAccountOwner(accountId);
      }
    }

    /**
     * Rules for the global /members/{memberId} collection.
     * Anyone can read public member data.
     * Only the owning account can create or modify a member document.
     */
    match /members/{memberId} {
      // Public read access for profile pages
      allow get: if true;
      allow list: if isSignedIn();

      // Allow create only if the accountId in the new data matches the user's UID.
      allow create: if isSignedIn() && request.resource.data.accountId == request.auth.uid;
      
      // Allow update/delete only if the existing document's accountId matches the user's UID.
      allow update, delete: if isSignedIn() && get(/databases/$(database)/documents/members/$(memberId)).data.accountId == request.auth.uid;
      
      match /downline/{downlineMemberId} {
         // Only the upline member (owner of the parent member document) can manage their downline.
         allow read, write: if isSignedIn() && get(/databases/$(database)/documents/members/$(memberId)).data.accountId == request.auth.uid;
      }
      
      match /wallet/{walletId} {
        allow read, write: if isSignedIn() && get(/databases/$(database)/documents/members/$(memberId)).data.accountId == request.auth.uid;
          
        match /transactions/{transactionId} {
          allow read, write: if isSignedIn() && get(/databases/$(database)/documents/members/$(memberId)).data.accountId == request.auth.uid;
        }
      }
      
      match /ai_sessions/{sessionId} {
         allow read, write: if isSignedIn() && get(/databases/$(database)/documents/members/$(memberId)).data.accountId == request.auth.uid;
      }
    }
    
    /**
     * Rules for the /counters/{counterId} collection.
     * This is only accessible from backend functions, not from the client.
     */
    match /counters/{counterId} {
      allow read, write: if false;
    }

    /**
     * Publicly readable collections with restricted writes.
     */
    match /quests/{questId} {
      allow read: if true;
      allow write: if false; // Should be admin-only
    }

    match /rewards/{rewardId} {
      allow read: if true;
      allow write: if false; // Should be admin-only
    }
    
    match /stores/{storeId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isSignedIn() && get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }
  }
}

    