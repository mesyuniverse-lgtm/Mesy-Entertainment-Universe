{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user account in the Mesy Entertainment Universe. All users are considered 'Members' upon registration, with varying levels of access based on their verification status. The system includes administrative roles like 'Admin' and 'Super-admin'.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity, matching Firebase Auth UID."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "Defines the user's account type and permissions. Defaults to 'Member'. Other roles include 'Developer', 'Admin', 'Super-admin'."
        },
        "level": {
          "type": "number",
          "description": "User's membership level, which determines income potential."
        },
        "verificationStatus": {
          "type": "string",
          "description": "Indicates the member's verification state: 'unverified', 'pending', 'verified'. Controls access to financial transactions and full features.",
          "enum": ["unverified", "pending", "verified"]
        },
        "profileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: User 1:1 UserProfile)"
        },
        "walletId": {
          "type": "string",
          "description": "Reference to Wallet. (Relationship: User 1:1 Wallet)"
        },
        "hasPinEnabled": {
            "type": "boolean",
            "description": "Indicates if the user has set up a PIN code for transactions."
        },
        "hasBiometricEnabled": {
            "type": "boolean",
            "description": "Indicates if the user has enabled biometric authentication (fingerprint, iris scan)."
        },
        "twoFactorMethods": {
            "type": "array",
            "description": "List of enabled two-factor authentication methods (e.g., 'app_otp', 'qr_code').",
            "items": {
                "type": "string",
                "enum": ["app_otp", "qr_code", "sms"]
            }
        }
      },
      "required": [
        "id",
        "email",
        "role",
        "level",
        "verificationStatus"
      ]
    },
    "MesyMember": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MesyMember",
      "type": "object",
      "description": "Represents a verified MESY Member with special privileges.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The unique identifier of the user (matches Firebase Auth UID)."
        },
        "memberId": {
          "type": "number",
          "description": "Unique sequential ID for the MESY Member."
        },
        "email": {
          "type": "string",
          "description": "Member's email address.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "Public display name for the member."
        },
        "role": {
          "type": "string",
          "description": "Member's role (e.g., Owner, Super-admin, Admin)."
        },
        "joinedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the user became a MESY Member."
        }
      },
      "required": ["userId", "memberId", "email", "role", "joinedAt"]
    },
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents the profile information of a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: UserProfile 1:1 User)"
        },
        "username": {
            "type": "string",
            "description": "User's unique, public-facing username."
        },
        "nickname": {
          "type": "string",
          "description": "User's displayed nickname."
        },
        "firstname": {
            "type": "string",
            "description": "User's first name."
        },
        "lastname": {
            "type": "string",
            "description": "User's last name."
        },
        "bio": {
          "type": "string",
          "description": "User's biography."
        },
        "avatar": {
          "type": "string",
          "description": "URL of the user's avatar image.",
          "format": "uri"
        },
        "socialLinks": {
          "type": "array",
          "description": "Array of social media links associated with the user.",
          "items": {
            "type": "string"
          }
        },
        "phoneNumber": {
            "type": "object",
            "description": "User's phone number, split into country code and number.",
            "properties": {
                "countryCode": { "type": "string", "description": "The international country calling code, e.g., '+66'." },
                "number": { "type": "string", "description": "The local phone number." }
            }
        },
        "nationalId": {
            "type": "string",
            "description": "User's national identification number. Should be encrypted at rest."
        },
        "address": {
            "type": "object",
            "description": "User's physical address.",
            "properties": {
                "street": { "type": "string" },
                "city": { "type": "string" },
                "region": { "type": "string", "description": "State, province, or region." },
                "postalCode": { "type": "string" },
                "country": { "type": "string" }
            }
        }
      },
      "required": [
        "id",
        "userId",
        "username",
        "nickname"
      ]
    },
    "Downline": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Downline",
      "type": "object",
      "description": "Represents a user's downline member.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the downline entity."
        },
        "memberId": {
          "type": "string",
          "description": "Unique sequential ID for the MESY Member."
        },
        "username": {
          "type": "string",
          "description": "Username of the downline member."
        },
        "avatar": {
          "type": "string",
          "description": "URL of the downline member's avatar.",
          "format": "uri"
        },
        "level": {
          "type": "number",
          "description": "Membership level of the downline member."
        },
        "joinDate": {
          "type": "string",
          "description": "Date when the downline member joined."
        },
        "stars": {
          "type": "number",
          "description": "Number of stars earned by the downline member."
        },
        "income": {
          "type": "number",
          "description": "Income generated by the downline member."
        },
        "downlines": {
          "type": "number",
          "description": "The number of downline members this specific member has."
        }
      },
      "required": [
        "id",
        "memberId",
        "username",
        "level",
        "joinDate",
        "downlines"
      ]
    },
    "Notification": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Notification",
      "type": "object",
      "description": "Represents a notification for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the notification entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Notification)"
        },
        "message": {
          "type": "string",
          "description": "Content of the notification message."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the notification was created.",
          "format": "date-time"
        },
        "read": {
          "type": "boolean",
          "description": "Indicates whether the notification has been read."
        }
      },
      "required": [
        "id",
        "userId",
        "message",
        "createdAt",
        "read"
      ]
    },
    "Quest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Quest",
      "type": "object",
      "description": "Represents a quest or challenge for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the quest entity."
        },
        "title": {
          "type": "string",
          "description": "Title of the quest."
        },
        "description": {
          "type": "string",
          "description": "Description of the quest."
        },
        "reward": {
          "type": "string",
          "description": "Description of the reward for completing the quest."
        },
        "status": {
          "type": "string",
          "description": "Current status of the quest (e.g., active, completed)."
        }
      },
      "required": [
        "id",
        "title",
        "description",
        "reward",
        "status"
      ]
    },
    "Reward": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Reward",
      "type": "object",
      "description": "Represents a reward that can be earned.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the reward entity."
        },
        "type": {
          "type": "string",
          "description": "Type of reward (e.g., discount, bonus, item)."
        },
        "value": {
          "type": "number",
          "description": "Value of the reward."
        },
        "expiry": {
          "type": "string",
          "description": "Expiration date of the reward.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "type",
        "value",
        "expiry"
      ]
    },
    "Store": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Store",
      "type": "object",
      "description": "Represents a store or marketplace.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the store entity."
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Store) ID of the store owner."
        },
        "products": {
          "type": "array",
          "description": "Array of product IDs available in the store.",
          "items": {
            "type": "string"
          }
        },
        "status": {
          "type": "string",
          "description": "Status of the store (e.g., open, closed, pending)."
        }
      },
      "required": [
        "id",
        "ownerId",
        "products",
        "status"
      ]
    },
    "AiSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AiSession",
      "type": "object",
      "description": "Represents a session of using the AI tools.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AI session entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N AiSession) ID of the user who initiated the session."
        },
        "type": {
          "type": "string",
          "description": "Type of AI tool used (e.g., content generator, avatar generator)."
        },
        "input": {
          "type": "string",
          "description": "Input provided to the AI tool."
        },
        "output": {
          "type": "string",
          "description": "Output generated by the AI tool."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the AI session occurred.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "type",
        "input",
        "output",
        "timestamp"
      ]
    },
    "Wallet": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Wallet",
      "type": "object",
      "description": "Represents the user's wallet for managing in-app currency.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the wallet."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 Wallet)"
        },
        "balance": {
          "type": "number",
          "description": "Current balance in the wallet."
        },
        "currency": {
          "type": "string",
          "description": "Type of currency used in the wallet."
        }
      },
      "required": [
        "id",
        "userId",
        "balance",
        "currency"
      ]
    },
    "WalletTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Wallet Transaction",
      "type": "object",
      "description": "Represents a single financial transaction within a user's wallet.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the transaction." },
        "walletId": { "type": "string", "description": "Reference to the Wallet. (Relationship: Wallet 1:N WalletTransaction)" },
        "type": {
          "type": "string",
          "description": "The type of transaction.",
          "enum": ["deposit", "withdrawal", "fee", "commission_income", "market_sale", "market_purchase", "quest_reward", "gift"]
        },
        "amount": { "type": "number", "description": "The transaction amount. Can be positive (income) or negative (expense)." },
        "description": { "type": "string", "description": "A brief description of the transaction, e.g., 'Monthly downline commission' or 'Purchase of Chrono Blade'." },
        "timestamp": { "type": "string", "format": "date-time", "description": "The exact time the transaction occurred." },
        "relatedEntityId": { "type": "string", "description": "Optional ID of a related entity, e.g., a product ID from a market purchase or a user ID from a gift." }
      },
      "required": ["id", "walletId", "type", "amount", "timestamp"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user account information. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "mesy-members/{userId}",
        "definition": {
          "entityName": "MesyMember",
          "schema": {
            "$ref": "#/backend/entities/MesyMember"
          },
          "description": "Stores information about verified MESY members with special privileges.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user, matching their Auth UID."
            }
          ]
        }
      },
      {
        "path": "users/{userId}/profile/{profileId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "profileId",
              "description": "The unique identifier for the user profile."
            }
          ]
        }
      },
      {
        "path": "users/{userId}/downline/{memberId}",
        "definition": {
          "entityName": "Downline",
          "schema": {
            "$ref": "#/backend/entities/Downline"
          },
          "description": "Stores downline member information for a user. Path-based ownership enables secure access. Enables QAPs for listing a user's downlines.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the upline user."
            },
            {
              "name": "memberId",
              "description": "The unique identifier for the downline member."
            }
          ]
        }
      },
      {
        "path": "users/{userId}/notifications/{notificationId}",
        "definition": {
          "entityName": "Notification",
          "schema": {
            "$ref": "#/backend/entities/Notification"
          },
          "description": "Stores notifications for a user. Path-based ownership enables secure access and QAPs for listing a user's notifications.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "notificationId",
              "description": "The unique identifier for the notification."
            }
          ]
        }
      },
      {
        "path": "quests/{questId}",
        "definition": {
          "entityName": "Quest",
          "schema": {
            "$ref": "#/backend/entities/Quest"
          },
          "description": "Stores quest information.",
          "params": [
            {
              "name": "questId",
              "description": "The unique identifier for the quest."
            }
          ]
        }
      },
      {
        "path": "rewards/{rewardId}",
        "definition": {
          "entityName": "Reward",
          "schema": {
            "$ref": "#/backend/entities/Reward"
          },
          "description": "Stores reward information.",
          "params": [
            {
              "name": "rewardId",
              "description": "The unique identifier for the reward."
            }
          ]
        }
      },
      {
        "path": "stores/{storeId}",
        "definition": {
          "entityName": "Store",
          "schema": {
            "$ref": "#/backend/entities/Store"
          },
          "description": "Stores store information.",
          "params": [
            {
              "name": "storeId",
              "description": "The unique identifier for the store."
            }
          ]
        }
      },
      {
        "path": "users/{userId}/ai_sessions/{sessionId}",
        "definition": {
          "entityName": "AiSession",
          "schema": {
            "$ref": "#/backend/entities/AiSession"
          },
          "description": "Stores AI session information for a user. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "sessionId",
              "description": "The unique identifier for the AI session."
            }
          ]
        }
      },
      {
        "path": "users/{userId}/wallet/{walletId}",
        "definition": {
          "entityName": "Wallet",
          "schema": {
            "$ref": "#/backend/entities/Wallet"
          },
          "description": "Stores wallet information for a user. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "walletId",
              "description": "The unique identifier for the wallet."
            }
          ]
        }
      },
      {
        "path": "users/{userId}/wallet/{walletId}/transactions/{transactionId}",
        "definition": {
          "entityName": "WalletTransaction",
          "schema": { "$ref": "#/backend/entities/WalletTransaction" },
          "description": "Stores individual financial transactions for a user's wallet. Path-based ownership enables secure access and QAPs for listing transactions.",
          "params": [
            { "name": "userId", "description": "The unique identifier for the user." },
            { "name": "walletId", "description": "The unique identifier for the wallet." },
            { "name": "transactionId", "description": "The unique identifier for the transaction." }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to align with the application's features, focusing on user data, membership management, and AI integration. The structure prioritizes **Authorization Independence** by avoiding hierarchical `get()` calls in security rules. User-owned data is organized under `/users/{userId}` for clear ownership. Downline data and other user-related data follow this pattern.\n\n**Authorization Independence & QAPs:**\n*   **User Profiles, Wallets, and AI Sessions:** Stored directly under `/users/{userId}` ensuring that access control is based solely on the authenticated user's ID, avoiding the need to fetch parent document data.\n*   **Downline:** Stored in `/users/{userId}/downline/{memberId}` where `userId` is the upline user. This segregation allows for secure listing (QAP) of a user's downlines based solely on their `userId`.\n*   **Notifications:**  Stored in `/users/{userId}/notifications/{notificationId}` where `userId` is the user to whom the notification belongs.  This segregation allows for secure listing (QAP) of a user's notifications based solely on their `userId`.\n*   **Wallet Transactions:** Stored in a subcollection under a user's wallet (`/users/{userId}/wallet/{walletId}/transactions/{transactionId}`). This ensures that a user can only read their own transactions and allows for efficient querying of a user's transaction history (QAP).\n*   **Stores:** Stored in `/stores/{storeId}` with `ownerId` property. A separate index on `ownerId` is recommended. This is a collaborative data structure, and uses path-based ownership, facilitating listing stores owned by a specific user and securing access to store details.\n\n**Structural Segregation:**\n*   Private user data like profiles, wallets, and AI sessions are stored under `/users/{userId}`, while shared data like stores are in a separate top-level collection `/stores`. This segregation allows clear separation of access control rules.\n\n**Access Modeling:**\n*   Path-based ownership (`/users/{userId}/...`) is used for private user data.\n*   Membership maps are not required because the structure is organized by user ID; roles are in the user document.\n\n**Invariants & Data Clarity:**\n*  Timestamps (`createdAt`, `timestamp`) are included in entities like `Notification` and `AiSession`.\n\nThis structure facilitates simple and robust security rules. For instance, read/write access to `/users/{userId}/profile` is easily restricted to the authenticated user with `request.auth.uid == userId`. Listing of notifications or wallet transactions for a specific user is also straightforward and secure."
  }
}
