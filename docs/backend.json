{
  "entities": {
    "Member": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Member",
      "type": "object",
      "description": "Represents a member's account in the Mesy Entertainment Universe. All accounts are considered 'Members' upon registration, with varying levels of access based on their verification status. The system includes administrative roles like 'Admin' and 'Super-admin'.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the member entity, matching Firebase Auth UID."
        },
        "email": {
          "type": "string",
          "description": "Member's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "Defines the member's account type and permissions. Defaults to 'Member'. Other roles include 'Developer', 'Admin', 'Super-admin'."
        },
        "level": {
          "type": "number",
          "description": "Member's membership level, which determines income potential."
        },
        "verificationStatus": {
          "type": "string",
          "description": "Indicates the member's verification state: 'unverified', 'pending', 'verified'. Controls access to financial transactions and full features.",
          "enum": ["unverified", "pending", "verified"]
        },
        "profileId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: Member 1:1 UserProfile)"
        },
        "walletId": {
          "type": "string",
          "description": "Reference to Wallet. (Relationship: Member 1:1 Wallet)"
        },
        "hasPinEnabled": {
            "type": "boolean",
            "description": "Indicates if the member has set up a PIN code for transactions."
        },
        "hasBiometricEnabled": {
            "type": "boolean",
            "description": "Indicates if the member has enabled biometric authentication (fingerprint, iris scan)."
        },
        "twoFactorMethods": {
            "type": "array",
            "description": "List of enabled two-factor authentication methods (e.g., 'app_otp', 'qr_code').",
            "items": {
                "type": "string",
                "enum": ["app_otp", "qr_code", "sms"]
            }
        }
      },
      "required": [
        "id",
        "email",
        "role",
        "level",
        "verificationStatus"
      ]
    },
    "MesyMember": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MesyMember",
      "type": "object",
      "description": "Represents a verified MESY Member with special privileges.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The unique identifier of the user (matches Firebase Auth UID)."
        },
        "memberId": {
          "type": "number",
          "description": "Unique sequential ID for the MESY Member."
        },
        "email": {
          "type": "string",
          "description": "Member's email address.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "Public display name for the member."
        },
        "role": {
          "type": "string",
          "description": "Member's role (e.g., Owner, Super-admin, Admin)."
        },
        "joinedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Timestamp of when the user became a MESY Member."
        }
      },
      "required": ["userId", "memberId", "email", "role", "joinedAt"]
    },
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Stores the publicly visible and private profile information for a member. Sensitive information should be protected by security rules.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile entity."
        },
        "memberId": {
          "type": "string",
          "description": "Reference to Member. (Relationship: UserProfile 1:1 Member)"
        },
        "username": {
            "type": "string",
            "description": "Member's unique, public-facing username."
        },
        "usernameLastChanged": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp of when the username was last changed, to enforce the 30-day cooldown."
        },
        "nickname": {
          "type": "string",
          "description": "Member's displayed nickname."
        },
        "firstname": {
            "type": "string",
            "description": "Member's first name."
        },
        "lastname": {
            "type": "string",
            "description": "Member's last name."
        },
        "bio": {
          "type": "string",
          "description": "Member's biography."
        },
        "avatar": {
          "type": "string",
          "description": "URL of the member's avatar image.",
          "format": "uri"
        },
        "socialLinks": {
          "type": "array",
          "description": "Array of social media links associated with the member.",
          "items": {
            "type": "string"
          }
        },
        "phoneNumber": {
            "type": "object",
            "description": "Member's phone number, split into country code and number. Should be verified.",
            "properties": {
                "countryCode": { "type": "string", "description": "The international country calling code, e.g., '+66'." },
                "number": { "type": "string", "description": "The local phone number." }
            }
        },
        "nationalId": {
            "type": "string",
            "description": "Member's national identification number. Should be encrypted at rest and only accessible by authorized admins."
        },
        "address": {
            "type": "object",
            "description": "Member's physical address, for billing and verification.",
            "properties": {
                "street": { "type": "string" },
                "city": { "type": "string" },
                "region": { "type": "string", "description": "State, province, or region." },
                "postalCode": { "type": "string" },
                "country": { "type": "string" }
            }
        }
      },
      "required": [
        "id",
        "memberId",
        "username",
        "nickname"
      ]
    },
    "Downline": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Downline",
      "type": "object",
      "description": "Represents a member's downline member.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the downline entity."
        },
        "memberId": {
          "type": "string",
          "description": "Unique sequential ID for the MESY Member."
        },
        "username": {
          "type": "string",
          "description": "Username of the downline member."
        },
        "avatar": {
          "type": "string",
          "description": "URL of the downline member's avatar.",
          "format": "uri"
        },
        "level": {
          "type": "number",
          "description": "Membership level of the downline member."
        },
        "joinDate": {
          "type": "string",
          "description": "Date when the downline member joined."
        },
        "stars": {
          "type": "number",
          "description": "Number of stars earned by the downline member."
        },
        "income": {
          "type": "number",
          "description": "Income generated by the downline member."
        },
        "downlines": {
          "type": "number",
          "description": "The number of downline members this specific member has."
        }
      },
      "required": [
        "id",
        "memberId",
        "username",
        "level",
        "joinDate",
        "downlines"
      ]
    },
    "Notification": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Notification",
      "type": "object",
      "description": "Represents a notification for a member.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the notification entity."
        },
        "memberId": {
          "type": "string",
          "description": "Reference to Member. (Relationship: Member 1:N Notification)"
        },
        "message": {
          "type": "string",
          "description": "Content of the notification message."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp of when the notification was created.",
          "format": "date-time"
        },
        "read": {
          "type": "boolean",
          "description": "Indicates whether the notification has been read."
        }
      },
      "required": [
        "id",
        "memberId",
        "message",
        "createdAt",
        "read"
      ]
    },
    "Quest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Quest",
      "type": "object",
      "description": "Represents a quest or challenge for a member.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the quest entity."
        },
        "title": {
          "type": "string",
          "description": "Title of the quest."
        },
        "description": {
          "type": "string",
          "description": "Description of the quest."
        },
        "reward": {
          "type": "string",
          "description": "Description of the reward for completing the quest."
        },
        "status": {
          "type": "string",
          "description": "Current status of the quest (e.g., active, completed)."
        }
      },
      "required": [
        "id",
        "title",
        "description",
        "reward",
        "status"
      ]
    },
    "Reward": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Reward",
      "type": "object",
      "description": "Represents a reward that can be earned.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the reward entity."
        },
        "type": {
          "type": "string",
          "description": "Type of reward (e.g., discount, bonus, item)."
        },
        "value": {
          "type": "number",
          "description": "Value of the reward."
        },
        "expiry": {
          "type": "string",
          "description": "Expiration date of the reward.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "type",
        "value",
        "expiry"
      ]
    },
    "Store": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Store",
      "type": "object",
      "description": "Represents a store or marketplace.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the store entity."
        },
        "ownerId": {
          "type": "string",
          "description": "Reference to Member. (Relationship: Member 1:N Store) ID of the store owner."
        },
        "products": {
          "type": "array",
          "description": "Array of product IDs available in the store.",
          "items": {
            "type": "string"
          }
        },
        "status": {
          "type": "string",
          "description": "Status of the store (e.g., open, closed, pending)."
        }
      },
      "required": [
        "id",
        "ownerId",
        "products",
        "status"
      ]
    },
    "AiSession": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AiSession",
      "type": "object",
      "description": "Represents a session of using the AI tools.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the AI session entity."
        },
        "memberId": {
          "type": "string",
          "description": "Reference to Member. (Relationship: Member 1:N AiSession) ID of the member who initiated the session."
        },
        "type": {
          "type": "string",
          "description": "Type of AI tool used (e.g., content generator, avatar generator)."
        },
        "input": {
          "type": "string",
          "description": "Input provided to the AI tool."
        },
        "output": {
          "type": "string",
          "description": "Output generated by the AI tool."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the AI session occurred.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "memberId",
        "type",
        "input",
        "output",
        "timestamp"
      ]
    },
    "Wallet": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Wallet",
      "type": "object",
      "description": "Represents the member's wallet for managing in-app currency.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the wallet."
        },
        "memberId": {
          "type": "string",
          "description": "Reference to Member. (Relationship: Member 1:1 Wallet)"
        },
        "balance": {
          "type": "number",
          "description": "Current balance in the wallet."
        },
        "currency": {
          "type": "string",
          "description": "Type of currency used in the wallet."
        }
      },
      "required": [
        "id",
        "memberId",
        "balance",
        "currency"
      ]
    },
    "WalletTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Wallet Transaction",
      "type": "object",
      "description": "Represents a single financial transaction within a member's wallet.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the transaction." },
        "walletId": { "type": "string", "description": "Reference to the Wallet. (Relationship: Wallet 1:N WalletTransaction)" },
        "type": {
          "type": "string",
          "description": "The type of transaction.",
          "enum": ["deposit", "withdrawal", "fee", "commission_income", "market_sale", "market_purchase", "quest_reward", "gift"]
        },
        "amount": { "type": "number", "description": "The transaction amount. Can be positive (income) or negative (expense)." },
        "description": { "type": "string", "description": "A brief description of the transaction, e.g., 'Monthly downline commission' or 'Purchase of Chrono Blade'." },
        "timestamp": { "type": "string", "format": "date-time", "description": "The exact time the transaction occurred." },
        "relatedEntityId": { "type": "string", "description": "Optional ID of a related entity, e.g., a product ID from a market purchase or a member ID from a gift." }
      },
      "required": ["id", "walletId", "type", "amount", "timestamp"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "members/{memberId}",
        "definition": {
          "entityName": "Member",
          "schema": {
            "$ref": "#/backend/entities/Member"
          },
          "description": "Stores member account information. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "memberId",
              "description": "The unique identifier for the member."
            }
          ]
        }
      },
      {
        "path": "mesy-members/{memberId}",
        "definition": {
          "entityName": "MesyMember",
          "schema": {
            "$ref": "#/backend/entities/MesyMember"
          },
          "description": "Stores information about verified MESY members with special privileges.",
          "params": [
            {
              "name": "memberId",
              "description": "The unique identifier for the member, matching their Auth UID."
            }
          ]
        }
      },
      {
        "path": "members/{memberId}/profile/{profileId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores member profile information. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "memberId",
              "description": "The unique identifier for the member."
            },
            {
              "name": "profileId",
              "description": "The unique identifier for the user profile."
            }
          ]
        }
      },
      {
        "path": "members/{memberId}/downline/{downlineMemberId}",
        "definition": {
          "entityName": "Downline",
          "schema": {
            "$ref": "#/backend/entities/Downline"
          },
          "description": "Stores downline member information for a member. Path-based ownership enables secure access. Enables QAPs for listing a member's downlines.",
          "params": [
            {
              "name": "memberId",
              "description": "The unique identifier for the upline member."
            },
            {
              "name": "downlineMemberId",
              "description": "The unique identifier for the downline member."
            }
          ]
        }
      },
      {
        "path": "members/{memberId}/notifications/{notificationId}",
        "definition": {
          "entityName": "Notification",
          "schema": {
            "$ref": "#/backend/entities/Notification"
          },
          "description": "Stores notifications for a member. Path-based ownership enables secure access and QAPs for listing a member's notifications.",
          "params": [
            {
              "name": "memberId",
              "description": "The unique identifier for the member."
            },
            {
              "name": "notificationId",
              "description": "The unique identifier for the notification."
            }
          ]
        }
      },
      {
        "path": "quests/{questId}",
        "definition": {
          "entityName": "Quest",
          "schema": {
            "$ref": "#/backend/entities/Quest"
          },
          "description": "Stores quest information.",
          "params": [
            {
              "name": "questId",
              "description": "The unique identifier for the quest."
            }
          ]
        }
      },
      {
        "path": "rewards/{rewardId}",
        "definition": {
          "entityName": "Reward",
          "schema": {
            "$ref": "#/backend/entities/Reward"
          },
          "description": "Stores reward information.",
          "params": [
            {
              "name": "rewardId",
              "description": "The unique identifier for the reward."
            }
          ]
        }
      },
      {
        "path": "stores/{storeId}",
        "definition": {
          "entityName": "Store",
          "schema": {
            "$ref": "#/backend/entities/Store"
          },
          "description": "Stores store information.",
          "params": [
            {
              "name": "storeId",
              "description": "The unique identifier for the store."
            }
          ]
        }
      },
      {
        "path": "members/{memberId}/ai_sessions/{sessionId}",
        "definition": {
          "entityName": "AiSession",
          "schema": {
            "$ref": "#/backend/entities/AiSession"
          },
          "description": "Stores AI session information for a member. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "memberId",
              "description": "The unique identifier for the member."
            },
            {
              "name": "sessionId",
              "description": "The unique identifier for the AI session."
            }
          ]
        }
      },
      {
        "path": "members/{memberId}/wallet/{walletId}",
        "definition": {
          "entityName": "Wallet",
          "schema": {
            "$ref": "#/backend/entities/Wallet"
          },
          "description": "Stores wallet information for a member. Path-based ownership enables secure access.",
          "params": [
            {
              "name": "memberId",
              "description": "The unique identifier for the member."
            },
            {
              "name": "walletId",
              "description": "The unique identifier for the wallet."
            }
          ]
        }
      },
      {
        "path": "members/{memberId}/wallet/{walletId}/transactions/{transactionId}",
        "definition": {
          "entityName": "WalletTransaction",
          "schema": { "$ref": "#/backend/entities/WalletTransaction" },
          "description": "Stores individual financial transactions for a member's wallet. Path-based ownership enables secure access and QAPs for listing transactions.",
          "params": [
            { "name": "memberId", "description": "The unique identifier for the member." },
            { "name": "walletId", "description": "The unique identifier for the wallet." },
            { "name": "transactionId", "description": "The unique identifier for the transaction." }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to align with the application's features, focusing on member data, membership management, and AI integration. The structure prioritizes **Authorization Independence** by avoiding hierarchical `get()` calls in security rules. Member-owned data is organized under `/members/{memberId}` for clear ownership. Downline data and other member-related data follow this pattern.\n\n**Authorization Independence & QAPs:**\n*   **User Profiles, Wallets, and AI Sessions:** Stored directly under `/members/{memberId}` ensuring that access control is based solely on the authenticated member's ID, avoiding the need to fetch parent document data.\n*   **Downline:** Stored in `/members/{memberId}/downline/{downlineMemberId}` where `memberId` is the upline member. This segregation allows for secure listing (QAP) of a member's downlines based solely on their `memberId`.\n*   **Notifications:**  Stored in `/members/{memberId}/notifications/{notificationId}` where `memberId` is the member to whom the notification belongs.  This segregation allows for secure listing (QAP) of a member's notifications based solely on their `memberId`.\n*   **Wallet Transactions:** Stored in a subcollection under a member's wallet (`/members/{memberId}/wallet/{walletId}/transactions/{transactionId}`). This ensures that a member can only read their own transactions and allows for efficient querying of a member's transaction history (QAP).\n*   **Stores:** Stored in `/stores/{storeId}` with `ownerId` property. A separate index on `ownerId` is recommended. This is a collaborative data structure, and uses path-based ownership, facilitating listing stores owned by a specific member and securing access to store details.\n\n**Structural Segregation:**\n*   Private member data like profiles, wallets, and AI sessions are stored under `/members/{memberId}`, while shared data like stores are in a separate top-level collection `/stores`. This segregation allows clear separation of access control rules.\n\n**Access Modeling:**\n*   Path-based ownership (`/members/{memberId}/...`) is used for private member data.\n*   Membership maps are not required because the structure is organized by member ID; roles are in the member document.\n\n**Invariants & Data Clarity:**\n*  Timestamps (`createdAt`, `timestamp`) are included in entities like `Notification` and `AiSession`.\n\nThis structure facilitates simple and robust security rules. For instance, read/write access to `/members/{memberId}/profile` is easily restricted to the authenticated member with `request.auth.uid == memberId`. Listing of notifications or wallet transactions for a specific member is also straightforward and secure."
  }
}

    